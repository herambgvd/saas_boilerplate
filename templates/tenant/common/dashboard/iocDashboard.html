{% extends "tenant/partials/base.html" %}
{% load static %}
{% block title %}IOC Dashboard{% endblock title %}
{% block extra_css %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet'/>
{% endblock extra_css %}
{% block content %}
    <!-- ============================================================== -->
    <!-- Start right Content here -->
    <!-- ============================================================== -->
    <div class="main-content">

        <div class="page-content">
            <div class="container-fluid">
                {% block pagetitle %}
                    {% include "tenant/partials/page-title.html" with pagetitle="IOC Dashboard" title="IOC Dashboard" subtitle="IOC" %}
                {% endblock pagetitle %}
                <!-- Branch, NVR, Panel, CCTV Counts -->
                <div class="row">
                    <div class="col-md-5">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card card-animate">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <p class="fw-medium text-muted mb-0">Locations</p>
                                                <h2 class="mt-4 ff-secondary fw-semibold"><span
                                                        class="branch-count"></span></h2>
                                            </div>
                                            <div>
                                                <div class="avatar-sm flex-shrink-0">
                                                            <span class="avatar-title bg-info-subtle rounded-circle fs-2">
                                                               <i class="ri-building-line fs-3 text-info"></i>
                                                            </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div><!-- end card body -->
                                </div> <!-- end card-->
                            </div> <!-- end col-->
                            <div class="col-md-6">
                                <div class="card card-animate">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <p class="fw-medium text-muted mb-0">NVR</p>
                                                <h2 class="mt-4 ff-secondary fw-semibold"><span
                                                        class="nvr-count"></span>
                                                </h2>
                                            </div>
                                            <div>
                                                <div class="avatar-sm flex-shrink-0">
                                                           <span class="avatar-title bg-info-subtle rounded-circle fs-2">
                                                                <i class="ri-hard-drive-2-line fs-3 text-info"></i>
                                                            </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div><!-- end card body -->
                                </div> <!-- end card-->
                            </div> <!-- end col-->
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card card-animate">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <p class="fw-medium text-muted mb-0">Panel</p>
                                                <h2 class="mt-4 ff-secondary fw-semibold"><span
                                                        class="panel-count"></span></h2>
                                            </div>
                                            <div>
                                                <div class="avatar-sm flex-shrink-0">
                                                            <span class="avatar-title bg-info-subtle rounded-circle fs-2">
                                                                <i class="ri-server-line fs-3 text-info"></i>
                                                            </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div><!-- end card body -->
                                </div> <!-- end card-->
                            </div> <!-- end col-->
                            <div class="col-md-6">
                                <div class="card card-animate">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <p class="fw-medium text-muted mb-0">Camera</p>
                                                <h2 class="mt-4 ff-secondary fw-semibold"><span
                                                        class="cctv-count"></span>
                                                </h2>
                                            </div>
                                            <div>
                                                <div class="avatar-sm flex-shrink-0">
                                                           <span class="avatar-title bg-info-subtle rounded-circle fs-2">
                                                                <i class=" bx bx-cctv fs-3 text-info"></i>
                                                            </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div><!-- end card body -->
                                </div> <!-- end card-->
                            </div> <!-- end col-->
                        </div>
                        <div class="row">
                            <div class="col">
                                <div class="card crm-widget">
                                    <div class="card-header">
                                        <span class="text text-muted">Demo Alerts</span>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="row row-cols-xxl-4 row-cols-md-4 row-cols-1 g-0">
                                            <div class="col">
                                                <div class="py-4 px-3">
                                                    <h5 class="text-muted text-uppercase fs-13 mb-3">Total</h5>
                                                    <div class="d-flex align-items-center">
                                                        <div class="spinner-grow text-primary" role="status">
                                                            <span class="sr-only">Total..</span>
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            <h4 class="mb-0"><span id="demo-total-count"></span>
                                                            </h4>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div><!-- end col -->
                                            <div class="col">
                                                <div class="py-4 px-3">
                                                    <h5 class="text-muted text-uppercase fs-13 mb-3">Open
                                                    </h5>
                                                    <div class="d-flex align-items-center">
                                                        <div class="spinner-grow text-warning" role="status">
                                                            <span class="sr-only">Open..</span>
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            <h4 class="mb-0"><span id="demo-open-count"></span>
                                                            </h4>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div><!-- end col -->
                                            <div class="col">
                                                <div class="py-4 px-3">
                                                    <h5 class="text-muted text-uppercase fs-13 mb-3">Closed
                                                    </h5>
                                                    <div class="d-flex align-items-center">
                                                        <div class="spinner-grow text-success" role="status">
                                                            <span class="sr-only">Close..</span>
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            <h4 class="mb-0"><span id="demo-close-count"></span>
                                                            </h4>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div><!-- end col -->
                                            <div class="col">
                                                <div class="py-4 px-3">
                                                    <h5 class="text-muted text-uppercase fs-13 mb-3">Pending
                                                    </h5>
                                                    <div class="d-flex align-items-center">
                                                        <div class="spinner-grow text-danger" role="status">
                                                            <span class="sr-only">Pending..</span>
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            <h4 class="mb-0"><span id="demo-pending-count"></span>
                                                            </h4>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div><!-- end col -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="card" id="dashboard">
                            <div class="card-header">
                                <span class="text text-muted">Branch Map</span>
                            </div>
                            <div class="card-body" id='map' style='width: 100%; height: 350px;'>
                            </div>
                        </div>
                    </div>
                </div>
                <!--End  Branch, NVR, Panel, CCTV Counts -->
                <div class="row">
                    <!-- Branch Distribution by Region -->
                    <div class="col-md-4">
                        <div class="card" id="dashboard">
                            <div class="card-header">
                                <span class="text text-muted">Branch Distribution by Region</span>
                            </div>
                            <div class="card-body" id="chart-container">
                                <canvas class="chartjs-chart" id="branchesPieChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Mapping Per Branch Data -->

                </div>
            </div>
            <!-- container-fluid -->
        </div>
        <!-- End Page-content -->

        {% block footer %}
            {% include "tenant/partials/footer.html" %}
        {% endblock footer %}
    </div>
    <!-- end main content-->
{% endblock content %}
{% block extra_js %}

    <script src="{% static 'libs/chart.js/dist/chart.umd.js' %}"></script>
    <!-- leaflet plugin   -->
    {#    <script src="{% static 'libs/leaflet/dist/leaflet.js' %}"></script>#}
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
    <!-- Branch Count and Map -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            $.ajax({
                url: '{% url "tenantHome:branch_data" %}',
                method: 'GET',
                success: function (data) {
                    const regions = ['North', 'East', 'West', 'South'];
                    const counts = [
                        data.North,
                        data.East,
                        data.West,
                        data.South
                    ];

                    <!-- Branch Count -->
                    const branchCountElement = $('span.branch-count');
                    branchCountElement.text(data.North);

                    const nvrCountElement = $('span.nvr-count');
                    nvrCountElement.text(data.nvr);

                    const cctvCountElement = $('span.cctv-count');
                    cctvCountElement.text(data.cctv);

                    const panelCountElement = $('span.panel-count');
                    panelCountElement.text(data.panel);

                    const ctx = document.getElementById('branchesPieChart').getContext('2d');
                    const branchesPieChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: regions,
                            datasets: [{
                                data: counts,
                                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#FF9999']
                            }]
                        },
                        options: {
                            responsive: true,
                            title: {
                                display: true,
                                text: 'Branch Distribution by Region'
                            }
                        }
                    });
                },
                error: function (error) {
                    console.error('Error fetching branch data', error);
                }
            });
            // Plot Branch on Map
            mapboxgl.accessToken = 'pk.eyJ1IjoiaGVyYW1ibSIsImEiOiJja3lsZjNwcnUyb240MnVxaGZ2Y2w1Y2lpIn0.CEsnNMuTnZJsBb0WaZIz4w';
            $.ajax({
                url: '{% url "tenantHome:get_branch_map" %}',
                method: 'GET',
                success: function (data) {
                    if (data.branches && data.branches.length > 0) {
                        const firstBranch = data.branches[0];

                        const map = new mapboxgl.Map({
                            container: 'map',
                            style: 'mapbox://styles/herambm/ckylha7inarjn15pcnih3hz4j',
                            center: [firstBranch.longitude, firstBranch.latitude], // Use the first branch's coordinates as the center
                            zoom: 2
                        });

                        map.addControl(new mapboxgl.NavigationControl());

                        data.branches.forEach(branch => {
                            const marker = new mapboxgl.Marker()
                                .setLngLat([branch.longitude, branch.latitude])
                                .addTo(map);

                            const popup = new mapboxgl.Popup({offset: 25})
                                .setHTML(`
                                            <span class="text-dark">${branch.name}
                                            <p>${branch.address}</p>
                                            <!-- Add more information as needed -->
                                        `);

                            marker.setPopup(popup);
                        });
                    } else {
                        console.error('No branches available');
                    }
                },
                error: function (error) {
                    console.error('Error fetching data', error);
                }
            });
            // Demo Alert Data
            $.ajax({
                url: '{% url "tenantHome:get_demo_alert_data" %}',
                method: 'GET',
                success: function (data) {
                    $('#demo-total-count').text(data.totalAlerts);
                    $('#demo-pending-count').text(data.pendingAlerts);
                    $('#demo-open-count').text(data.openAlerts);
                    $('#demo-close-count').text(data.closeAlerts);
                },
                error: function (error) {
                    console.error('Error fetching data', error);
                }
            });

        });
    </script>
{% endblock extra_js %}